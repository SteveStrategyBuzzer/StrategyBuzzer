<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;

class SoloController extends Controller
{
    public function index(Request $request)
    {
        // Nouveau joueur : dÃ©marre Ã  1 si absent
        if (!session()->has('choix_niveau')) {
            session(['choix_niveau' => 1]);
        }

        $choix_niveau       = session('choix_niveau', 1);            // niveau max dÃ©bloquÃ©
        $niveau_selectionne = session('niveau_selectionne', $choix_niveau); // par dÃ©faut le max dÃ©bloquÃ©
        $avatar             = session('avatar', 'Aucun');            // avatar optionnel
        $nb_questions       = session('nb_questions', null);

        return view('solo', [
            'choix_niveau'       => $choix_niveau,
            'niveau_selectionne' => $niveau_selectionne,
            'avatar_stratÃ©gique'      => $avatar,
            'nb_questions'       => $nb_questions,
        ]);
    }

    public function start(Request $request)
    {
        // Avatar non requis => on ne le valide pas ici
        $validated = $request->validate([
            'nb_questions'  => 'required|integer|min:1',
            'theme'         => 'required|string',
            'niveau_joueur' => 'required|integer|min:1|max:100',
        ]);

        $theme        = $validated['theme'];
        $nbQuestions  = $validated['nb_questions'];
        $niveau       = $validated['niveau_joueur'];

        // SÃ©curise : ne pas dÃ©passer le niveau dÃ©bloquÃ©
        $max = session('choix_niveau', 1);
        if ($niveau > $max) $niveau = $max;

        // Persistance session
        session([
            'niveau_selectionne' => $niveau,
            'nb_questions'       => $nbQuestions,
            'theme'              => $theme,
        ]);

        // Avatar vraiment optionnel
        if (!session()->has('avatar') || empty(session('avatar'))) {
            session(['avatar' => 'Aucun']);
        }
        $avatar = session('avatar', 'Aucun');

        // Questions fictives (placeholder)
        $questions = [
            [
                'id' => 1,
                'question_text' => "Combien de pays sont dans lâ€™ONU ?",
                'answers' => [
                    ['id' => 1, 'text' => '201'],
                    ['id' => 2, 'text' => '193'],
                    ['id' => 3, 'text' => '179'],
                    ['id' => 4, 'text' => '101'],
                ],
                'correct_id' => 2,
            ],
        ];

        $themeIcons = [
            'general'    => 'ğŸ§ ',
            'geographie' => 'ğŸŒ',
            'histoire'   => 'ğŸ“œ',
            'art'        => 'ğŸ¨',
            'cinema'     => 'ğŸ¬',
            'sport'      => 'ğŸ…',
            'cuisine'    => 'ğŸ³',
            'faune'      => 'ğŸ¦',
        ];

        $params = [
            'theme'           => $theme,
            'theme_icon'      => $themeIcons[$theme] ?? 'â“',
            'avatar'          => $avatar,
            'avatar_skills'   => $this->getAvatarSkills($avatar),
            'nb_questions'    => $nbQuestions,
            'niveau_joueur'   => $niveau,
            'current'         => 1,
            'question_id'     => $questions[0]['id'],
            'question_text'   => $questions[0]['question_text'],
            'answers'         => $questions[0]['answers'],
        ];

        return view('resume', compact('params'));
    }

    public function resume()
    {
        $params = session('params', []);
        return view('resume', compact('params'));
    }

    public function game()
    {
        return view('solo_gameplay');
    }

    public function answer(Request $request)
    {
        // TODO: validation/logique de rÃ©ponse
        return redirect()->route('solo.game');
    }

    public function stat()
    {
        $data = [
            'score'        => 8,
            'total'        => 10,
            'pourcentage'  => 80,
            'niveau'       => session('niveau_selectionne', '?'),
            'theme'        => session('theme', '?'),
            'avatar'       => session('avatar', 'Aucun'),
        ];

        return view('stat', compact('data'));
    }

    private function getAvatarSkills($avatar)
    {
        $skills = [
            'Aucun'         => [],
            'MathÃ©maticien' => ['Rejouer 1 fois', 'Analyse rapide', 'Double points'],
            'Scientifique'  => ['Ã‰liminer 1 mauvaise rÃ©ponse', 'Indice logique'],
            'Explorateur'   => ['+5 sec', 'Carte bonus'],
        ];
        return $skills[$avatar] ?? [];
    }
}
