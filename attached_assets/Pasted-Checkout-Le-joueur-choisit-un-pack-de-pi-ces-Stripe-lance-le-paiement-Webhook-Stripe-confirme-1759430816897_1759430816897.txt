Checkout → Le joueur choisit un pack de pièces, Stripe lance le paiement.

Webhook → Stripe confirme le paiement → ton jeu crédite les pièces d’intelligence automatiquement au joueur.

Étape 1 — Ajout dans .env

Dans ton fichier .env ajoute :

STRIPE_KEY=pk_test_xxxxxxxxxxxxxxxxx
STRIPE_SECRET=sk_test_xxxxxxxxxxxxxxxxx
STRIPE_WEBHOOK_SECRET=whsec_xxxxxxxxxxxxxxxxx

Étape 2 — Fichier app/Http/Controllers/StripeController.php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Stripe\Stripe;
use Stripe\Checkout\Session;
use Illuminate\Support\Facades\Auth;
use App\Models\User;

class StripeController extends Controller
{
    // Démarre un paiement Stripe Checkout
    public function checkout(Request $request)
    {
        Stripe::setApiKey(env('STRIPE_SECRET'));

        // ID du prix Stripe envoyé depuis ton front (lié au produit)
        $priceId = $request->input('price_id');

        $session = Session::create([
            'payment_method_types' => ['card'],
            'line_items' => [[
                'price' => $priceId,
                'quantity' => 1,
            ]],
            'mode' => 'payment',
            'success_url' => url('/payment/success'),
            'cancel_url' => url('/payment/cancel'),
            'metadata' => [
                'user_id' => Auth::id(), // pour savoir quel joueur créditer
            ],
        ]);

        return response()->json(['id' => $session->id]);
    }

    // Webhook Stripe → Confirmation de paiement
    public function webhook(Request $request)
    {
        $endpoint_secret = env('STRIPE_WEBHOOK_SECRET');
        $payload = @file_get_contents('php://input');
        $sig_header = $_SERVER['HTTP_STRIPE_SIGNATURE'] ?? '';
        $event = null;

        try {
            $event = \Stripe\Webhook::constructEvent(
                $payload, $sig_header, $endpoint_secret
            );
        } catch (\UnexpectedValueException $e) {
            return response('Invalid payload', 400);
        } catch (\Stripe\Exception\SignatureVerificationException $e) {
            return response('Invalid signature', 400);
        }

        // Vérifie le type d’événement
        if ($event->type === 'checkout.session.completed') {
            $session = $event->data->object;

            // Récupère le user_id et le produit payé
            $userId = $session->metadata->user_id ?? null;
            $lineItems = \Stripe\Checkout\Session::retrieve($session->id, [
                'expand' => ['line_items']
            ])->line_items;

            if ($userId && count($lineItems->data)) {
                $product = $lineItems->data[0]->price->product;
                $stripeProduct = \Stripe\Product::retrieve($product);

                // Vérifie les métadonnées du produit
                if (isset($stripeProduct->metadata['type']) && $stripeProduct->metadata['type'] === 'coins_pack') {
                    $amount = (int) $stripeProduct->metadata['amount'];

                    $user = User::find($userId);
                    if ($user) {
                        // Ajoute les pièces dans la DB
                        $user->intelligence_pieces = ($user->intelligence_pieces ?? 0) + $amount;
                        $user->save();
                    }
                }
            }
        }

        return response('Webhook handled', 200);
    }
}

Étape 3 — Routes routes/web.php
use App\Http\Controllers\StripeController;

Route::post('/stripe/checkout', [StripeController::class, 'checkout'])->name('stripe.checkout');
Route::post('/stripe/webhook', [StripeController::class, 'webhook'])->name('stripe.webhook');

Étape 4 — Migration (si pas encore de colonne pour les pièces)

Ajoute une colonne intelligence_pieces dans ta table users :

php artisan make:migration add_intelligence_pieces_to_users_table --table=users


Puis dans la migration :

public function up()
{
    Schema::table('users', function (Blueprint $table) {
        $table->integer('intelligence_pieces')->default(0);
    });
}


Et applique :

php artisan migrate

Étape 5 — Test en mode Test Stripe

Crée tes produits "Pièces d’intelligence" avec métadonnées :

type=coins_pack

amount=500 (ou 1000, 2500, etc.)

Lance /stripe/checkout → paie avec une carte de test Stripe (4242 4242 4242 4242).

Stripe appelle ton webhook → ton joueur reçoit automatiquement ses pièces.